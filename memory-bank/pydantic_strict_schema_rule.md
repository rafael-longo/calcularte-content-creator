# Engineering Principle: Strict Pydantic Model Compliance for Agent Outputs

## 1. The Core Mandate

To ensure system reliability and leverage the guaranteed data contracts of the OpenAI Agents SDK, all Pydantic models used as `output_type` for agents or as parameter types for `FunctionTool` **MUST** be designed to generate a "Strict JSON Schema."

This is not an optional guideline; it is a foundational principle for building robust, predictable, and maintainable agents. The default SDK behavior (`output_schema_strict=True`) is a deliberate architectural choice to enforce reliability, and we will adhere to it.

## 2. The "Why": From Unreliable JSON to Guaranteed Contracts

- **Past Problem:** Early LLM "JSON Mode" was syntactically valid but structurally unpredictable, requiring brittle post-processing and extensive error handling.
- **Present Solution:** The SDK's "Structured Outputs" feature (`strict: true`) provides a foolproof contract. The API guarantees that the output will strictly conform to the provided JSON Schema.
- **Our Stance:** We build on this guarantee. The burden of reliability should lie with the platform's contract, not our application's error-handling code. Disabling this feature with `output_schema_strict=False` is considered an anti-pattern and is only permissible as a temporary measure during initial prototyping, with a clear plan to refactor to a compliant model.

## 3. Canonical Rules for Strict Pydantic Models

The following rules are a direct translation of the OpenAI API's requirements for strict schemas. All agent-facing models must comply.

### Rule 3.1: No Generic Dictionaries

- **Violation:** Using `dict` or `Dict[str, Any]` as a field type.
- **Reason:** This generates a schema that lacks the mandatory `"additionalProperties": false` declaration, which is the most common cause of the "Strict JSON schema... not valid" error.
- **Correction:** Always define a specific, nested `pydantic.BaseModel` for any object structure.

**Example:**

```python
# NON-COMPLIANT
class NonCompliantModel(BaseModel):
    metadata: dict # This will fail validation

# COMPLIANT
class Metadata(BaseModel):
    key: str
    value: str

class CompliantModel(BaseModel):
    metadata: Metadata # Correct: uses a nested, defined model
```

### Rule 3.2: All Fields are Required by Default (Use `Optional` for Optionality)

- **Violation:** Assuming `field: str = None` makes a field optional in a strict context.
- **Reason:** Every property in a strict schema's `properties` block must also be in its `required` array. True optionality is achieved by allowing the field's value to be `null`.
- **Correction:** Use `typing.Optional[T]` or `typing.Union[T, None]` for any field that is not guaranteed to be present.

**Example:**

```python
# NON-COMPLIANT
class NonCompliantModel(BaseModel):
    notes: str = None # Incorrect optionality

# COMPLIANT
class CompliantModel(BaseModel):
    notes: Optional[str] # Correct: generates {"type": ["string", "null"]}
```

### Rule 3.3: No Unsupported Validation Keywords

- **Violation:** Using Pydantic's `Field` constraints that map to unsupported JSON Schema keywords.
- **Reason:** The strict schema validator disallows common constraints.
- **Correction:** All business logic validation (e.g., string length, number ranges) **MUST** be performed in application code *after* the model has been successfully generated by the agent.

**Forbidden `Field` Arguments Include:**
- `min_length`, `max_length`, `pattern`
- `ge`, `le`, `gt`, `lt`, `multiple_of`
- `min_items`, `max_items`

## 4. Proactive Validation Workflow

To prevent these errors, developers **MUST** proactively validate their models before integrating them into an agent.

**Standard Debugging Snippet:**

```python
from pydantic import TypeAdapter
import json

# Replace with the model you are designing
from .my_agent_models import MyNewOutputModel

try:
    # Generate and print the schema for inspection
    adapter = TypeAdapter(MyNewOutputModel)
    generated_schema = adapter.json_schema()
    print(json.dumps(generated_schema, indent=2))
    
    # Manually inspect the output for forbidden keywords or missing
    # "additionalProperties": false declarations.

except Exception as e:
    print(f"Schema generation failed: {e}")

```

By adhering to this principle, we ensure our system is robust, maintainable, and correctly aligned with the architecture of the underlying AI platform.
